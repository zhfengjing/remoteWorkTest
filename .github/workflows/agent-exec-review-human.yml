name: Agent - Execute (Codex) & Review (Human Claude)

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  codex_execute_from_issue:
    if: github.event_name == 'issues' && github.event.label.name == 'plan:approved'
    runs-on: ubuntu-latest
    steps:
      - name: Comment @codex with plan and rules
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;

            const comments = await github.rest.issues.listComments({
              owner, repo, issue_number, per_page: 100
            });

            function extractPlan(body) {
              if (!body) return null;
              const start = body.indexOf('<!-- PLAN START -->');
              const end = body.indexOf('<!-- PLAN END -->');
              if (start === -1 || end === -1 || end <= start) return null;
              return body.slice(start, end + '<!-- PLAN END -->'.length);
            }

            let planText = null;
            for (let i = comments.data.length - 1; i >= 0; i--) {
              const maybe = extractPlan(comments.data[i].body || '');
              if (maybe) { planText = maybe; break; }
            }
            if (!planText) {
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: '⚠️ 找不到 PLAN 标记（<!-- PLAN START --> / <!-- PLAN END -->）。请先把 Claude Plan 粘贴到评论里再加 plan:approved。'
              });
              return;
            }

            const body = [
              '@codex',
              '',
              'Task: Implement the plan below and open a PR (or update the same PR branch if possible).',
              '',
              'Rules:',
              '1) Follow the plan order; keep changes minimal and coherent.',
              '2) Run: `npm test` (and anything else in Test Plan).',
              '3) Paste test results into the PR description.',
              '4) If unclear requirements, ask questions in the PR.',
              '5) Avoid unrelated refactors/formatting.',
              '',
              '---',
              planText
            ].join('\n');

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ['needs:codex']
            }).catch(() => {});

  prompt_human_review_on_pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Ask human to review with Claude Pro
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;

            const body = [
              '## Human Claude Review Needed (Claude Pro)',
              '',
              '请你在 Claude Desktop（Pro）里做 Review，然后把结论粘贴为 PR 评论，并在最后一行写清楚：',
              '',
              '`Verdict: APPROVE` 或 `Verdict: REQUEST_CHANGES`',
              '',
              'Review 要点：',
              '- 对照 Issue 里的 Acceptance Criteria',
              '- 确认 `npm test` 通过（至少要求执行/或在 PR 描述里有结果）',
              '',
              '如果是 REQUEST_CHANGES，请列出 blocking checklist，Codex 会根据 checklist 继续改。',
            ].join('\n');

            await github.rest.issues.createComment({
              owner, repo, issue_number: pr_number,
              body
            });

  handle_human_verdict:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - name: Parse human verdict and label + optionally ping codex
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.issue.number;
            const text = (context.payload.comment.body || '').trim();

            const approve = text.includes('Verdict: APPROVE');
            const request = text.includes('Verdict: REQUEST_CHANGES');
            if (!approve && !request) return;

            async function remove(name) {
              await github.rest.issues.removeLabel({ owner, repo, issue_number: pr_number, name }).catch(() => {});
            }
            await remove('merge:approved');
            await remove('changes:requested');
            await remove('needs:codex');

            if (approve) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: pr_number,
                labels: ['merge:approved']
              });
              return;
            }

            if (request) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: pr_number,
                labels: ['changes:requested', 'needs:codex']
              });

              const ping = [
                '@codex',
                '',
                'Please address the requested changes described in the latest human Claude review comment.',
                'Rules:',
                '- Focus on the blocking checklist.',
                '- Re-run: `npm test`.',
                '- Update PR description with results.',
              ].join('\n');

              await github.rest.issues.createComment({
                owner, repo, issue_number: pr_number,
                body: ping
              });
            }