name: Agent - Plan (Claude)

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  plan:
    if: github.event.label.name == 'plan:needed'
    runs-on: ubuntu-latest
    steps:
      - name: Claude produces an executable plan
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are Claude in PLAN MODE.
            Write an executable plan for the GitHub issue.

            Output MUST be Markdown and include sections EXACTLY:
            1) Goal
            2) Non-goals
            3) Assumptions / Open questions
            4) Plan (numbered; each step small enough to be a single commit)
            5) Acceptance Criteria (checklist)
            6) Test Plan (commands to run)
            7) Risk & Rollback

            Hard constraints:
            - Do NOT write code.
            - Keep it concise but complete.
            - Use "npm test" in the Test Plan when tests are applicable.
            - Put the whole plan between these markers:
              <!-- PLAN START -->
              <!-- PLAN END -->

      - name: Switch labels plan:needed -> plan:approved
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;

            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ['plan:approved']
            });

            await github.rest.issues.removeLabel({
              owner, repo, issue_number,
              name: 'plan:needed'
            }).catch(() => {});